<?php
// @description Enqueue scripts

if (!defined('ABSPATH')) exit;

function theme_scripts() {
    wp_enqueue_style('dashicons');
    wp_enqueue_style('bootstrap_css', 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/css/bootstrap.min.css');
    wp_register_script('bootstrap_js', 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.min.js', array('jquery'), null, true);
    wp_enqueue_script('bootstrap_js');

    if (is_page(pmpro_getOption('checkout_page_slug')) || is_page(pmpro_getOption('billing_page_slug')) || is_page(pmpro_getOption('account_page_slug'))) {
        $level_id = 0;
        $level_price = 0;
        $current_user_level = pmpro_getMembershipLevelForUser(get_current_user_id());
        if (!empty($current_user_level) && isset($current_user_level->id)) {
            $level_id = $current_user_level->id;
            $level_price = floatval($current_user_level->initial_payment);
        }
        if (is_page(pmpro_getOption('checkout_page_slug'))) {
            global $pmpro_level;
            if (!empty($pmpro_level) && isset($pmpro_level->id)) {
                $level_id = $pmpro_level->id;
                $level_price = floatval($pmpro_level->initial_payment);
            } elseif (isset($_REQUEST['level'])) {
                $requested_level_id = intval($_REQUEST['level']);
                $level_obj = pmpro_getLevel($requested_level_id);
                if (!empty($level_obj) && isset($level_obj->initial_payment)) {
                    $level_id = $level_obj->id;
                    $level_price = floatval($level_obj->initial_payment);
                }
            }
        }
        
        // Corregir la ruta del script
        $js_url = plugins_url('storage/js/theme-scripts.js', dirname(dirname(__FILE__)));
        
        wp_enqueue_script(
            'nextcloud-pricing-script', 
            $js_url,
            array('jquery'),
            null,
            true
        );
        
        wp_localize_script('nextcloud-pricing-script', 'nextcloud_pricing', array(
            'level_id' => $level_id,
            'base_price' => $level_price,
            'currency_symbol' => 'R$'
        ));
    }
}

// Asegurarse de que el hook se registre en el momento correcto
function register_theme_scripts() {
    add_action('wp_enqueue_scripts', 'theme_scripts');
}
add_action('init', 'register_theme_scripts');
